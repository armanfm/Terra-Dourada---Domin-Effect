# Batch Processing Architecture with Rollups and Semaphore â€“ Terra Dourada Domino Effect

The system consists of three main layers that work together to process batches in a parallel, secure, and resilient manner, creating a domino effect that ensures speed, redundancy, and reliability.

## 1. Mini-Rollups Layer

- Each mini-rollup attempts to process batches available in the off-chain semaphore.
- Only open batches (green) can be disputed.
- The winning mini-rollup generates the ZK proof for the batch.
- If a mini-rollup fails during the ZK proof, other mini-rollups can take over the batch, maintaining continuous flow.
- When a mini-rollup fails, the semaphore turns yellow (reopened), indicating priority, and a higher reward is recommended to incentivize the next attempt.

**Freedom and Resilience:** Mini-rollups are not tied to a specific batch. They can alternate between open or reopened batches, ensuring the system continues operating even in the face of failures or delays in generating ZK proofs, without blocking the global flow.

## 2. Main Rollups Layer

- The main rollup checks the on-chain smart contract to verify if the batch is finalized, open, reopened, or in progress.
- If the batch is open or reopened, it waits to aggregate valid ZK proofs generated by one or more mini-rollups.
- It validates the proof and sends it to the smart contract, which finalizes the batch on-chain.
- While no mini-rollup has generated a valid proof, the batch remains in progress (white) in the smart contract.
- If a main rollup fails in its own ZK proof generation, it is replaced by a competing provider, similar to mini-rollups.

**Domino Effect:** Each main rollup that finalizes a batch coordinately releases adjacent batches, propagating continuous and efficient processing across the network.

**Semaphore and Smart Contract Status:**

- Green: open
- Red: finalized
- Yellow: reopened (mini-rollup failure, priority/reward)
- White: in progress (smart contract awaiting valid ZK proof)

## 3. On-Chain Smart Contract Layer

- Acts as the final authority, recording batches as finalized on the blockchain.
- Ensures that no batch is processed twice.
- Emits events that synchronize the semaphore and main rollups, maintaining correct order and active domino effect.

## 4. Domino Effect

- Mini-rollups do not need to wait for proofs from competitors, reducing latency and saving energy.
- Main rollups follow the same logic as mini-rollups but do not compete for the same batch.
- Main rollups dynamically assume batches, validate ZK proofs, and release finalized batches to the smart contract, ensuring continuous domino effect across the network.
